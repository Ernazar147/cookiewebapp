<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tookie Cookie üç™</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.6/babel.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #fce4ec, #f8bbd0); }
        .cookie-card { transition: transform 0.3s; }
        .cookie-card:hover { transform: scale(1.05); }
        .cart-item { border-bottom: 1px solid #f0f0f0; }
        .error { background-color: #ffebee; color: #d81b60; }
        .loader { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const cookies = [
            { id: 1, name: "–®–æ–∫–æ–ª–∞–¥–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", emoji: "üç´", price: 5000, description: "–ù–µ–∂–Ω–æ–µ —Å –∫—É—Å–æ—á–∫–∞–º–∏ —à–æ–∫–æ–ª–∞–¥–∞" },
            { id: 2, name: "–û–≤—Å—è–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", emoji: "üåæ", price: 4000, description: "–ü–æ–ª–µ–∑–Ω–æ–µ —Å –æ–≤—Å—è–Ω–∫–æ–π" },
            { id: 3, name: "–ö–ª—É–±–Ω–∏—á–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", emoji: "üçì", price: 6000, description: "–°–ª–∞–¥–∫–æ–µ —Å –∫–ª—É–±–Ω–∏—á–Ω—ã–º –¥–∂–µ–º–æ–º" },
        ];

        function App() {
            const [userId, setUserId] = useState(null);
            const [lang, setLang] = useState('ru');
            const [cart, setCart] = useState([]);
            const [promo, setPromo] = useState('');
            const [deliveryType, setDeliveryType] = useState('delivery');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(true);

            const TEXTS = {
                ru: {
                    title: "Tookie Cookie üç™",
                    welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏ —Å–≤–æ–∏ –ª—é–±–∏–º—ã–µ –ø–µ—á–µ–Ω—å–∫–∏! üòã",
                    cart: "–ö–æ—Ä–∑–∏–Ω–∞",
                    emptyCart: "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üòî",
                    promo: "–ü—Ä–æ–º–æ–∫–æ–¥",
                    delivery: "–î–æ—Å—Ç–∞–≤–∫–∞",
                    pickup: "–°–∞–º–æ–≤—ã–≤–æ–∑",
                    total: "–ò—Ç–æ–≥–æ",
                    checkout: "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑",
                    sum: "—Å—É–º",
                    error: "–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞! üòï",
                },
                uz: {
                    title: "Tookie Cookie üç™",
                    welcome: "Xush kelibsiz! Sevimli pechenyelaringizni tanlang! üòã",
                    cart: "Savat",
                    emptyCart: "Sizning savatingiz bo'sh üòî",
                    promo: "Promokod",
                    delivery: "Yetkazib berish",
                    pickup: "Olib ketish",
                    total: "Jami",
                    checkout: "Buyurtma berish",
                    sum: "so'm",
                    error: "Xato! Internetni tekshiring va qayta urinib ko'ring! üòï",
                }
            };

            useEffect(() => {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const userIdParam = urlParams.get('user_id');
                    const langParam = urlParams.get('lang') || 'ru';
                    if (userIdParam) {
                        setUserId(userIdParam);
                        setLang(langParam);
                        setLoading(false);
                    } else {
                        setError(TEXTS[langParam].error);
                        setLoading(false);
                    }
                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.ready();
                        window.Telegram.WebApp.expand();
                    }
                } catch (e) {
                    setError(TEXTS[lang].error);
                    setLoading(false);
                }
            }, []);

            const addToCart = (cookie) => {
                setCart(prev => {
                    const existing = prev.find(item => item.id === cookie.id);
                    if (existing) {
                        return prev.map(item =>
                            item.id === cookie.id ? { ...item, quantity: item.quantity + 1 } : item
                        );
                    }
                    return [...prev, { ...cookie, quantity: 1 }];
                });
            };

            const removeFromCart = (cookieId) => {
                setCart(prev => prev.filter(item => item.id !== cookieId));
            };

            const updateQuantity = (cookieId, quantity) => {
                if (quantity < 1) {
                    removeFromCart(cookieId);
                    return;
                }
                setCart(prev => prev.map(item =>
                    item.id === cookieId ? { ...item, quantity } : item
                ));
            };

            const calculateTotal = () => {
                return cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            };

            const handleCheckout = () => {
                if (!userId) {
                    setError(TEXTS[lang].error);
                    return;
                }
                if (cart.length === 0) {
                    setError(TEXTS[lang].emptyCart);
                    return;
                }
                const orderData = {
                    action: 'order',
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        emoji: item.emoji,
                        price: item.price,
                        quantity: item.quantity,
                        description: item.description
                    })),
                    delivery_type: deliveryType,
                    promo: promo || null,
                    total: calculateTotal()
                };
                try {
                    window.Telegram.WebApp.sendData(JSON.stringify(orderData));
                    window.Telegram.WebApp.close();
                } catch (e) {
                    setError(TEXTS[lang].error);
                }
            };

            if (loading) {
                return (
                    <div className="flex justify-center items-center h-screen">
                        <div className="loader w-12 h-12 bg-center bg-no-repeat" style={{ backgroundImage: "url('https://via.placeholder.com/60?text=üç™')" }}></div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container mx-auto p-4 text-center">
                        <h1 className="text-3xl font-bold text-pink-600">{TEXTS[lang].title}</h1>
                        <p className="error p-4 mt-4 rounded">{error}</p>
                        <button
                            className="mt-4 bg-pink-600 text-white py-2 px-4 rounded hover:bg-pink-700"
                            onClick={() => window.location.reload()}
                        >
                            {lang === 'ru' ? '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞' : 'Qayta urinish'}
                        </button>
                    </div>
                );
            }

            return (
                <div className="container mx-auto p-4">
                    <h1 className="text-3xl font-bold text-pink-600 text-center mb-6">{TEXTS[lang].title}</h1>
                    <p className="text-lg text-gray-700 text-center mb-8">{TEXTS[lang].welcome}</p>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        {cookies.map(cookie => (
                            <div key={cookie.id} className="cookie-card bg-white p-4 rounded-lg shadow-lg">
                                <h2 className="text-xl font-semibold text-pink-600">{cookie.emoji} {cookie.name}</h2>
                                <p className="text-gray-600">{cookie.description}</p>
                                <p className="text-lg font-bold text-pink-600">{cookie.price} {TEXTS[lang].sum}</p>
                                <button
                                    className="mt-2 bg-pink-600 text-white py-2 px-4 rounded hover:bg-pink-700"
                                    onClick={() => addToCart(cookie)}
                                >
                                    {lang === 'ru' ? '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É' : "Savatga qo'shish"}
                                </button>
                            </div>
                        ))}
                    </div>

                    <h2 className="text-2xl font-bold text-pink-600 mb-4">{TEXTS[lang].cart}</h2>
                    {cart.length === 0 ? (
                        <p className="text-gray-600">{TEXTS[lang].emptyCart}</p>
                    ) : (
                        <div className="bg-white p-4 rounded-lg shadow-lg mb-8">
                            {cart.map(item => (
                                <div key={item.id} className="cart-item flex justify-between items-center p-2">
                                    <div>
                                        <p className="text-lg font-semibold">{item.emoji} {item.name}</p>
                                        <p className="text-gray-600">{item.price} {TEXTS[lang].sum} x {item.quantity}</p>
                                    </div>
                                    <div className="flex items-center">
                                        <button
                                            className="bg-pink-600 text-white px-2 py-1 rounded"
                                            onClick={() => updateQuantity(item.id, item.quantity - 1)}
                                        >
                                            -
                                        </button>
                                        <span className="mx-2">{item.quantity}</span>
                                        <button
                                            className="bg-pink-600 text-white px-2 py-1 rounded"
                                            onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                        >
                                            +
                                        </button>
                                    </div>
                                </div>
                            ))}
                            <div className="mt-4">
                                <label className="block text-gray-700">{TEXTS[lang].promo}</label>
                                <input
                                    type="text"
                                    className="w-full p-2 border rounded"
                                    value={promo}
                                    onChange={(e) => setPromo(e.target.value)}
                                    placeholder={lang === 'ru' ? '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥' : "Promokodni kiriting"}
                                />
                            </div>
                            <div className="mt-4">
                                <label className="block text-gray-700">{lang === 'ru' ? '–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏' : "Yetkazib berish turi"}</label>
                                <select
                                    className="w-full p-2 border rounded"
                                    value={deliveryType}
                                    onChange={(e) => setDeliveryType(e.target.value)}
                                >
                                    <option value="delivery">{TEXTS[lang].delivery}</option>
                                    <option value="pickup">{TEXTS[lang].pickup}</option>
                                </select>
                            </div>
                            <p className="mt-4 text-lg font-bold text-pink-600">
                                {TEXTS[lang].total}: {calculateTotal()} {TEXTS[lang].sum}
                            </p>
                            <button
                                className="mt-4 bg-pink-600 text-white py-2 px-4 rounded hover:bg-pink-700 w-full"
                                onClick={handleCheckout}
                            >
                                {TEXTS[lang].checkout}
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>